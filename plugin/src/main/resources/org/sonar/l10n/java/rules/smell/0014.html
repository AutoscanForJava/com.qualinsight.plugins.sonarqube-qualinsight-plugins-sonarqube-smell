There is a way to simplify this algorithm.